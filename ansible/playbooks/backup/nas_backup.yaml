---
# Had issues with the bash script failing from Semaphore and this provides a cleaner mechanism for integrating with Uptime Kuma and give a nice web dashboard vs something like Cron
- name: SYNC Backups to NAS
  hosts: "{{ hosts }}"
  gather_facts: false
  tasks:

    # - name: Get the executing user's name
    #   ansible.builtin.command: whoami
    #   register: user_name_result

    # - name: Display executing user's name
    #   ansible.builtin.debug:
    #     msg: "Executing user's name: {{ user_name_result.stdout }}"

    - name: Wake NAS
      community.general.wakeonlan:
        mac: '2c:44:fd:1c:61:62'
      delegate_to: localhost

    - name: Wait for NAS to become reachable
      ansible.builtin.wait_for_connection:

    # Mount module requires a bunch of duplcate info that's already provided in fstab and configured on the host
    # Don't want to duplicate that complexity here so running like this instead
    # https://andreas.scherbaum.la/post/2019-12-09_ansible-just-mount-an-existing-filesystem/
    - name: Mount NAS
      command: "mount -v {{ MOUNT_PATH }}"
      become: true
      register: mount_result      

    - name: Execute rsync command
      ansible.builtin.raw: |
        rsync -rtEvv --delete --exclude=".*/" /media/ext_storage/backups/ /mnt/nas_replicate_out/vector/backups_sync/
      register: rsync_result
      ignore_errors: yes

    - name: Notify uptime monitoring - success
      ansible.builtin.uri:
        url: "https://uptime-kuma.ournetwork.ca/api/push/XcfEl3F0QF?status=up&msg=OK&ping="
        method: GET
      when: rsync_result.rc == 0

    - name: Notify uptime monitoring - failure
      ansible.builtin.uri:
        url: "https://uptime-kuma.ournetwork.ca/api/push/XcfEl3F0QF?status=down&msg=OK&ping="
        method: GET
      when: rsync_result.rc != 0

    - name: Fail if rsync fails
      ansible.builtin.fail:
        msg: "Rsync failed with return code {{ rsync_result.rc }}."
      when: rsync_result.rc != 0

    # Precautionary sleep to give previous commands time to release their open files.
    # During testing of unmount it would fail if it was done too soon after previous interactions with the share
    - name: Sleep
      ansible.builtin.wait_for:
        timeout: 5
      delegate_to: localhost

    - name: Unmount NAS
      become: true
      ansible.posix.mount:
        path: "{{ MOUNT_PATH }}"
        state: unmounted      