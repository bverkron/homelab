---
# Had issues with the bash script failing from Semaphore and this provides a cleaner mechanism for integrating with Uptime Kuma and give a nice web dashboard vs something like Cron
- name: SYNC Backups to NAS
  hosts: "{{ hosts }}"
  gather_facts: false
  tasks:
    - name: Execute rsync command
      ansible.builtin.raw: |
        rsync -rtEvv --delete --exclude=".*/" /media/ext_storage/backups/ /mnt/nas_replicate_out/vector/backups_sync/
      register: rsync_result
      ignore_errors: yes

    - name: Notify uptime monitoring - success
      ansible.builtin.uri:
        url: "https://uptime-kuma.ournetwork.ca/api/push/XcfEl3F0QF?status=up&msg=OK&ping="
        method: GET
      when: rsync_result.rc == 0

    - name: Notify uptime monitoring - failure
      ansible.builtin.uri:
        url: "https://uptime-kuma.ournetwork.ca/api/push/XcfEl3F0QF?status=down&msg=OK&ping="
        method: GET
      when: rsync_result.rc != 0

    - name: Fail if rsync fails
      ansible.builtin.fail:
        msg: "Rsync failed with return code {{ rsync_result.rc }}."
      when: rsync_result.rc != 0      